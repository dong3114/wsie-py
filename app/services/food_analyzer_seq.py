# -*- coding: utf-8 -*-
"""ìŒì‹ ë¶„ì„ ìŠ¤í¬ë¦½íŠ¸ (Sequential)

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1t0Y6htNhzwCwDaaJELwz0o5h1GGqCAXX
"""

# -*- coding: utf-8 -*-
"""
ìŒì‹ë¬¼ ì“°ë ˆê¸° ì´ë¯¸ì§€ ë¶„ì„ ë° ë¦¬í¬íŠ¸ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ (SequentialChain ë°©ì‹)
"""
from dotenv import load_dotenv
load_dotenv()

import base64
import os
import json
from openai import OpenAI
from langchain_openai import ChatOpenAI
from langchain.prompts import PromptTemplate
from langchain.chains import LLMChain

# -----------------------------
# 0. ì´ˆê¸°í™”
# -----------------------------
# API í‚¤ëŠ” í™˜ê²½ ë³€ìˆ˜(OPENAI_API_KEY)ì— ì„¤ì •í•´ë‘ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
try:
    client = OpenAI()
    llm = ChatOpenAI(model="gpt-4o", temperature=0)
except Exception as e:
    print(f"ğŸš¨ OpenAI ë˜ëŠ” LangChain ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
    print("OPENAI_API_KEYê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.")
    print(f"ì˜¤ë¥˜ ìƒì„¸: {e}")
    exit()

# -----------------------------
# 1. ë©€í‹°ëª¨ë‹¬ ë¶„ì„ í•¨ìˆ˜
# -----------------------------
def analyze_food(image_path: str) -> str:
    """ì´ë¯¸ì§€ ê²½ë¡œë¥¼ ë°›ì•„ GPT-4oë¡œ ë¶„ì„í•˜ê³  ê²°ê³¼ë¥¼ JSON ë¬¸ìì—´ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤."""
    try:
        with open(image_path, "rb") as f:
            img_bytes = f.read()
        img_base64 = base64.b64encode(img_bytes).decode("utf-8")

        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {"role": "system", "content": "ë‹¹ì‹ ì€ ì‹ë‹¹ì˜ ë‚¨ê¸´ ìŒì‹ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. JSONìœ¼ë¡œë§Œ ë‹µë³€í•˜ì„¸ìš”."},
                {"role": "user",
                 "content": [
                     {"type": "text", "text": "ì´ ìŒì‹ ì‚¬ì§„ì„ ë³´ê³  ìŒì‹ ì¢…ë¥˜ì™€ ë‚¨ì€ ì–‘ì„ JSON í˜•ì‹ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”."},
                     {"type": "image_url",
                      "image_url": {"url": f"data:image/jpeg;base64,{img_base64}"}}
                 ]}
            ]
        )
        return response.choices[0].message.content
    except FileNotFoundError:
        print(f"ì˜¤ë¥˜: ì´ë¯¸ì§€ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”: {image_path}")
        return None
    except Exception as e:
        print(f"ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return None

# -----------------------------
# 2. LangChain ì²´ì¸ êµ¬ì„±
# -----------------------------
def setup_chains():
    """ë¦¬í¬íŠ¸ì™€ ê°œì„  ë°©ì•ˆì„ ìƒì„±í•˜ëŠ” ë‘ ê°œì˜ LLMChainì„ êµ¬ì„±í•©ë‹ˆë‹¤."""
    # ë¦¬í¬íŠ¸ ìƒì„± ì²´ì¸
    report_prompt = PromptTemplate(
        input_variables=['analysis'],
        template="""
    ë‹¤ìŒì€ ì‹íŒ ì”ë°˜ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤:
    {analysis}

    ì´ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‹ë‹¹ ì”ë°˜ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”.
    ê° í•­ëª©ë³„ë¡œ ë¬¸ì¥ ë‹¨ë½ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.
    ì˜ˆ: "ë°¥ì€ ì ˆë°˜ ë‚¨ì•˜ìŠµë‹ˆë‹¤. ê¹€ì¹˜ëŠ” ê±°ì˜ ë‹¤ ë¨¹ì—ˆìŠµë‹ˆë‹¤. ë‚˜ë¬¼ì€ ê·¸ëŒ€ë¡œ ì…ë‹ˆë‹¤."
    """
    )
    report_chain = LLMChain(llm=llm, prompt=report_prompt, output_key="report")

    # ê°œì„  ë°©ì•ˆ ìƒì„± ì²´ì¸
    improve_prompt = PromptTemplate(
        input_variables=['analysis'],
        template="""
    ë‹¤ìŒì€ ì”ë°˜ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤:
    {analysis}

    ì´ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‹ë‹¹ ìŒì‹ ê°œì„  ë°©ì•ˆì„ ì œì•ˆí•´ì£¼ì„¸ìš”.
    ì´ ê²°ê³¼ë§Œ ë°”íƒ•ìœ¼ë¡œ **ìˆœìˆ˜ í…ìŠ¤íŠ¸ ë¦¬í¬íŠ¸**ë¡œ ì‘ì„±í•˜ì„¸ìš”.
    ë‚ ì§œ/ì‘ì„±ì/ì—°ë½ì²˜ ë“±ì€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.
    """
    )
    improve_chain = LLMChain(llm=llm, prompt=improve_prompt, output_key='improvements')

    return report_chain, improve_chain

# -----------------------------
# 3. ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜
# -----------------------------
def main():
    """ë©”ì¸ ì‹¤í–‰ ë¡œì§"""
    print("--- ìŒì‹ë¬¼ ì“°ë ˆê¸° ë¶„ì„ê¸° (Sequential ë°©ì‹) ---")

    image_path = input("ë¶„ì„í•  ì´ë¯¸ì§€ íŒŒì¼ì˜ ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ./data/3.jpg): ")

    if not os.path.exists(image_path):
        print(f"ì˜¤ë¥˜: '{image_path}' ê²½ë¡œì— íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
        return

    print("\n1. ì´ë¯¸ì§€ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...")
    analysis_result = analyze_food(image_path)

    if analysis_result:
        print("ë¶„ì„ ì™„ë£Œ!")

        report_chain, improve_chain = setup_chains()

        print("\n2. ë¦¬í¬íŠ¸ ë° ê°œì„  ë°©ì•ˆì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...")
        report = report_chain.run({"analysis": analysis_result})
        improvements = improve_chain.run({"analysis": analysis_result})
        print("ìƒì„± ì™„ë£Œ!")

        print("\n\n--- ìµœì¢… ê²°ê³¼ ---")
        print("ğŸ“Œ ë¦¬í¬íŠ¸:")
        print(report)

        print("\nğŸ“Œ ê°œì„  ë°©ì•ˆ:")
        print(improvements)

if __name__ == "__main__":
    main()